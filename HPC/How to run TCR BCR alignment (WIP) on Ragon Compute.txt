Panda Express!
How to align PE TCR/BCR fastqs

######################################
Part 0: Get everything set up to run #
######################################

1. Update your load scripts (see Dropbox, /Shalek Lab/Protocols/Comp Scripts/loadScripts/README)

2. Install UGER_tools in your personal bin (this is how you would install any software you'd like to use that isn't common)

cd ~/
git clone https://github.com/Carldeboer/UGER_tools
mkdir ~/bin
cp UGER_tools/{newGEArrayJob,newGEHead,submitlog} ~/bin


###################################################
Part 1: All aboard the Panda Express i.e. PANDAseq #
###################################################


1. Make a folder in FASTQs and copy your aligned FASTQ files to the new folder
mkdir /broad/ragon_compute/Data/FASTQs/<RUN_NAME>/

cp /broad/ragon_compute/Data/MiSeqRuns/<MISEQ RUN NAME>/Data/Intensities/BaseCalls/*.fastq /broad/ragon_compute/Data/FASTQs/<RUN_NAME>/

2. Remove the index files and undetermined, since we don't need them anymore
rm *I1*.fastq.gz
rm *I2*.fastq.gz
rm Undetermined*

3. Run Panda_Express_1.sh script to merge PE files into SE files. The new paired files are automatically put in a folder called paired_fastqs

bash /broad/ragon_compute/scripts/TCR_BCR_alignment/Panda_Express_1.sh /broad/ragon_compute/Data/FASTQs/<RUN_NAME>/<SPECIES>

NOTE: Step 3 may take a while. 


######################################################
Part 2: Align the paired fastqs using MIGMAP on UGER #
######################################################

1.Change directory to where your paired fastqs are:
cd /broad/ragon_compute/Data/FASTQs/<RUN_NAME>/paired_fastqs

2. In the paired_fastqs folder run the following in order to generate a txt file with all the files you want to send through alignment
ls -1 *fastq > tasks.txt

3. Submit the job for alignment (make sure to choose the right migmap_ file for you need (ie TCR/BCR & hs/mm)	
submitlog -t 6:00:00 -P regevlab -m 16 -o tasksrun.out -t tasks.txt /broad/ragon_compute/scripts/TCR_BCR_alignment/migmap_<TCR/BCR>_<hs/mm>.sh tasks.txt


This will generate an aligned file, plus a corrected align file. We will use the corrected align file (which allows for errors up to 2 bp) moving forward. 

################################################
Part 3: Grab the consensus from each alignment #
################################################

1. Move your analysis over to a folder in Analysis
mkdir -p /broad/ragon_compute/Data/Analysis/<RUN_NAME>/hs

cp -rv /broad/ragon_compute/Data/<RUN_NAME>/paired_fastqs/aligned/ /broad/ragon_compute/Data/Analysis/<RUN_NAME>/hs

2. Run the collect consensus script below to produce a txt file with the consensus from every cell (run in the directory containing the aligned txt files)
cd /broad/ragon_compute/Data/Analysis/<RUN_NAME>/hs/aligned/

Make sure you are in the folder with the corrected alignment files

use Anaconda 
python2.7 /broad/ragon_compute/scripts/TCR_BCR_alignment/collect_migmap_results_<TCR/BCR>.py


BELOW IS EXPERIMENTAL
submitlog -q long -P regevlab -m 16 -o tasksrun.out -t tasks.txt /broad/ragon_compute/scripts/TCR_BCR_alignment/migmap_BCR_hs.sh tasks.txt








TESTING
to remove end of lines:
perl -pe ’s,<regex>,,’ file.txt > file2.txt

compare two files and output what is only in the first file
comm -23 --check-order file1.txt file2.txt

submitlog -t 48:00:00 -P regevlab -m 16 -o tasksrun.out -t tasks.txt /broad/ragon_compute/scripts/TCR_BCR_alignment/migmap_TCR_hs.sh tasks.txt
